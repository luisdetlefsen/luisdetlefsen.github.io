<!DOCTYPE html>
<html>
    <head>
        <title>Prey and predator</title>
        <!--title> All living things are born, grow, reproduce and die</title-->
    </head>
    <body>

        <style>

            body{
                background-color: #585858 !important;
                color: black !important;
                padding: 5px !important;
            }

            #container {
                width: 100%; /*can be in percentage also.*/
                height: auto;
                margin: 0 auto;
                padding: 10px;
                position: relative;
            }

            .row{
                /* margin-right: -15px; */
                margin-left: 0px !important; 
            }

            .prey{
                /*    background-color: #BBEDD2;
               //     padding: 10px;*/
            }

            .predator{
                /*    background-color: #B5B5B5;
                    padding: 10px;*/
            }

            .food{
                /*          background-color: #DC9A6A;
                          padding: 10px;*/
            }

            .general{
                /*     background: #E9A5D0;
                     padding: 10px;*/
            }
            .panel-heading{
                font-weight: bold;
            }

            .panel-body{
                margin: 15px !important;
                background-image: url("Content/img/bg.bmp");
                min-height: 500px !important;
            }


            .carousel-indicators li{
                border-radius: 0 !important;
            }


        </style>
        <link href="Content/bootstrap.min.css" rel="stylesheet"/>
        <link href="Content/Site.css" rel="stylesheet"/>
        <script src="Scripts/jquery-2.1.4.min.js"></script>
        <script src="Scripts/pixi/pixi.min.js"></script>
        <script src="Scripts/bootstrap.min.js" type="text/javascript"></script>

        <div class="modal fade" id="initScreen" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Prey - Predator</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- modal body start  -->
                        <div id="carouselTutorial" class="carousel slide" >
                            <!-- Indicators -->
                            <ol class="carousel-indicators">
                                <li data-target="#carouselTutorial" data-slide-to="0" class="active"></li>
                                <li data-target="#carouselTutorial" data-slide-to="1"></li>
                                <li data-target="#carouselTutorial" data-slide-to="2"></li>
                                <li data-target="#carouselTutorial" data-slide-to="3"></li>
                                <li data-target="#carouselTutorial" data-slide-to="4"></li>
                                <li data-target="#carouselTutorial" data-slide-to="5"></li>
                            </ol>

                            <!-- Wrapper for slides -->
                            <div class="carousel-inner" role="listbox">
                                <div class="item active">
                                    <img src="Content/img/bg.bmp" alt="...">

                                    Welcome. Objective goes here
                                    <div class="carousel-caption">
                                        Caption one
                                    </div>
                                </div>
                                <div class="item">
                                    <img src="Content/img/bg.bmp" alt="...">
                                    Explain stats
                                    <div class="carousel-caption">
                                        Caption two
                                    </div>
                                </div>
                                <div class="item">
                                    <div class="panel panel-info">
                                        <div class="panel-heading">Prey settings  <img src="Content/img/smileys/happyt.png" /> </div>
                                        <div class="panel-body">
                                            <div class="row prey">            
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="preyAmount">Initial number of preys</label>
                                                    <input class="form-control" id='preyAmount' type="number" value="5" step="1" min="0" />
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="preySpeed">Speed</label>
                                                    <input class="form-control" id='preySpeed' type="number" value="5" />
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="distancePredator">Distance to detect predator</label>
                                                    <input class="form-control" id='distancePredator' type="number" value="50" step="1" min="0" />
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="distanceFood">Distance to detect food</label>
                                                    <input class="form-control" id='distanceFood' type="number" value="30" step="1" min="0" />
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="preyMateDistance">Distance to detect mate</label>
                                                    <input class="form-control" id='preyMateDistance' type="number" value="40" step="1" min="0" />
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="preyMateThreshold">Reproduce when energy is above</label>
                                                    <input class="form-control" id='preyMateThreshold' type="number" value="0.4" step="0.1" min="0" />
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="maxPreyEnergy">Max energy</label>
                                                    <input class="form-control" id='maxPreyEnergy' type="number" value="1000" step="1" min="0" />
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="eatThreshold">Eat when energy is below</label>
                                                    <input class="form-control" id='eatThreshold' type="number" value="0.8" step="0.1" min="0" />
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="preyMatingDuration">Mating duration</label>
                                                    <input class="form-control" id='preyMatingDuration' type="number" value="100" step="1" min="0" />
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="preyMateSpan">Mating span</label>
                                                    <input class="form-control" id='preyMateSpan' type="number" value="1000" step="1" min="0" />
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="preyMaxAge">Max age</label>
                                                    <input class="form-control" id='preyMaxAge' type="number" value="10" step="1" min="0" />
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="preyMinMateAge">Min age to reproduce</label>
                                                    <input class="form-control" id='preyMinMateAge' type="number" value="100" step="1" min="0" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="carousel-caption">
                                        Caption three
                                    </div>
                                </div>
                                <div class="item">
                                    <div class="panel panel-danger">
                                        <div class="panel-heading">Predator settings  <img src="Content/img/smileys/angryt.png" /></div>
                                        <div class="panel-body">
                                            <div class="row predator">
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="predatorCount">Initial number of predators</label>
                                                    <input class="form-control" id='predatorCount' type="number" value="3" />
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for='predatorSpeed'>Speed</label>
                                                    <input class="form-control"  id='predatorSpeed' type="number" value="2" />
                                                </div>    
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="predatorMateDistance">Distance to detect mate</label>
                                                    <input class="form-control" id='predatorMateDistance' type="number" value="60" step="1" min="0" />
                                                </div>

                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="distanceDetectPrey">Distance to detect prey</label>
                                                    <input class="form-control" id='distanceDetectPrey' type="number" value="60" step="1" min="0" />
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="maxPredatorEnergy">Max energy</label>
                                                    <input class="form-control" id='maxPredatorEnergy' type="number" value="5000" step="1" min="0" />
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="predatorEatThreshold">Eat when energy is below</label>
                                                    <input class="form-control" id='predatorEatThreshold' type="number" value="0.95" step="0.05" min="0" />
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="predatorMateThreshold">Reproduce when energy is above</label>
                                                    <input class="form-control" id='predatorMateThreshold' type="number" value="0.6" step="0.05" min="0" />
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="predatorMatingDuration">Mating duration</label>
                                                    <input class="form-control" id='predatorMatingDuration' type="number" value="200" step="1" min="0" />
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="predatorMateSpan">Mating span</label>
                                                    <input class="form-control" id='predatorMateSpan' type="number" value="100" step="1" min="0" />
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="predatorMaxAge">Max age</label>
                                                    <input class="form-control" id='predatorMaxAge' type="number" value="5" step="1" min="0" />
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="predatorMinMateAge">Min age to reproduce</label>
                                                    <input class="form-control" id='predatorMinMateAge' type="number" value="100" step="1" min="0" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="carousel-caption">
                                        Caption three
                                    </div>
                                </div>
                                <div class="item">
                                    <div class="panel panel-success">
                                        <div class="panel-heading">Food settings  <img src="Content/img/smileys/pizzat.png" /> </div>
                                        <div class="panel-body">
                                            <div class='row food'>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="foodAmount">Food quantity</label>
                                                    <input class="form-control" id='foodAmount' type="number" value="5" step="1" min="0" />
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="maxFoodEnergy">Energy provided</label>
                                                    <input class="form-control" id='maxFoodEnergy' type="number" value="200" step="1" min="0" />
                                                </div>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="foodInterval">Appear every</label>
                                                    <input class="form-control" id='foodInterval' type="number" value="10000" step="1" min="0" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="carousel-caption">
                                        Caption three
                                    </div>
                                </div>
                                <div class="item">
                                    <div class="panel panel-primary">
                                        <div class="panel-heading">General settings</div>
                                        <div class="panel-body">
                                            <div class='row general'>
                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <label for="ageInterval">Increase age every</label>
                                                    <input class="form-control" id='ageInterval' type="number" value="5000" step="1" min="0" />
                                                </div>

                                                <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                                                    <div class="form-check">
                                                        <label class="form-check-label">
                                                            <input class="form-check-input" type="checkbox" value="" id='inDebug'>
                                                            Display debug information
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="carousel-caption">
                                        Caption three
                                    </div>
                                </div>

                            </div>

                            <!-- Controls -->
                            <a class="left carousel-control" href="#carouselTutorial" role="button" data-slide="prev">
                                <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                                <span class="sr-only">Previous</span>
                            </a>
                            <a class="right carousel-control" href="#carouselTutorial" role="button" data-slide="next">
                                <span class="glyphicon glyphicon-chevron-right" aria-hidden="true">   </span>
                                <span class="sr-only">Next</span>
                            </a>
                        </div>
                        <!-- modal body end -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary">Save changes</button>
                        <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>











        <div class='row'>
            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                <button type="submit" class="btn btn-primary" id="btnStart" onclick="start()">Start</button>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">                    
                <button type="submit" class="btn btn-danger" id="btnStop" onclick='stop()' style='display:  none;'>Stop</button>                
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">                    
                <button type="submit" class="btn btn-primary" onclick='showConfig()'>Settings</button>                
            </div>
        </div>


        <div class="row">

            <div id="container" style="margin:10px;"></div>

        </div>

        <div class="row">
            <span>Select a style for the stats graph:</span>
            <select name="graphOpts" id="graphOpts" onchange="selectGraphType()">
                <option value="0">Filled</option>
                <option value="1">Lineal</option>             
            </select>
        </div>
        <div class="row" id="simTimeDiv">
            <label>Simulation time:</label> <span id="simTime"></span>
        </div>
        <div class="row">
            <div class="col-lg-3 col-md-3 col-sm-3 col-xs-3">
                <table>
                    <tr><td style="background-color: #8B008B;color:white;">Prey male</td></tr> 
                    <tr><td style="background-color: #DDA0DD;color:white;">Prey female</td></tr>
                    <tr><td style="background-color: #0000CD;color:white;">Predator male</td></tr>
                    <tr><td style="background-color: #87CEEB;color:white;">Predator female</td></tr>
                    <tr><td style="background-color: #FFA500;color:white;">Food</td></tr>
                </table>
            </div>
            <div class="col-lg-9 col-md-9 col-sm-9 col-xs-9">
                <div id="statistics"></div>
            </div>
        </div>


        <script>
            /* 
             * FIXME: a prey should not get out of the bounds of the world when it is running away
             predator should increase its energy when it eats a prey
             * TODO: prey should die if it gets in contact with a predator
             * TODO: newborns should not have max energy
             * TODO: there should be a max age to reproduce
             prey should have an age
             predator should have an age
             prey and predator should have a life expectancy
             TODO: prey should have a priority: mate or eat
             prey should die when it reaches the maximum age
             predator should die when it reaches the maximum age
             food should have an amount that can be eaten
             food should spawn randomly every X time
             prey should have energy
             prey should decrease its energy when it is not eating
             prey should increase its energy when it is eating
             prey should run towards food
             prey should eat only when energy is below a certain threshold             
             prey should seek another prey to mate
             prey should have a gender
             prey should mate with another prey of different sex
             prey mating act should have a duration
             prey should die if it runs out of energy
             predator should chase a prey when it is near             
             predator should have energy
             predator should seek another predator to mate             
             predator should decrease its energy when it is not eating
             predator should have a gender
             predator should mate with another predator of different gender0
             predator should die if it runs out of energy             
             add urge to mate to prey 
             add urge to mate to predator
             */

            var windowWidth = window.innerWidth * 0.95;
            var windowHeight = window.innerHeight * 0.7;
            var app;
            var MALE = 0, FEMALE = 1;
            var GENDER = [MALE, FEMALE];
            var UP = 0, DOWN = 1, RIGHT = 2, LEFT = 3;
            var XDIR = [RIGHT, LEFT];
            var YDIR = [UP, DOWN];
            var DEAD = 0, EATING = 1, HAPPY = 2, SCARED = 3, SLEEPING = 4, WORRIED = 5, SMILE = 6, ANGRY = 7, MATING = 8, LURKING = 9, CHASING = 10;
            var moods = [DEAD, EATING, HAPPY, SCARED, SLEEPING, WORRIED, SMILE, ANGRY];
            var imagesBasePath = 'Content/img/smileys/';
            var pizzaTexture = PIXI.Texture.fromImage(imagesBasePath + 'pizzat.png');
            var deadTexture = PIXI.Texture.fromImage(imagesBasePath + 'deadt.png');
            var eatingTexture = PIXI.Texture.fromImage(imagesBasePath + 'eatingt.png');
            var happyTexture = PIXI.Texture.fromImage(imagesBasePath + 'happyt.png');
            var scaredTexture = PIXI.Texture.fromImage(imagesBasePath + 'scaredt.png');
            var sleepingTexture = PIXI.Texture.fromImage(imagesBasePath + 'sleeping.png');
            var worriedTexture = PIXI.Texture.fromImage(imagesBasePath + 'worriedt.png');
            var smileTexture = PIXI.Texture.fromImage(imagesBasePath + 'smile.png');
            var angryTexture = PIXI.Texture.fromImage(imagesBasePath + 'angryt.png');
            var matingTexture = PIXI.Texture.fromImage(imagesBasePath + 'sleeping.png');
            var femaleTexture = PIXI.Texture.fromImage(imagesBasePath + 'female.png');
            var maleTexture = PIXI.Texture.fromImage(imagesBasePath + 'male.png');
            var healthBarTexture = PIXI.Texture.fromImage(imagesBasePath + 'solidWhiteBar.png');
            var transparentBarTexture = PIXI.Texture.fromImage(imagesBasePath + 'transparentBar.png');
            var preySkullTexture = PIXI.Texture.fromImage(imagesBasePath + 'preySkull.png');
            var emptyPlateTexture = PIXI.Texture.fromImage(imagesBasePath + 'emptyPlate.png');
            var predatorDeadTexture = PIXI.Texture.fromImage(imagesBasePath + 'predatorDead.png');

            var running = false;

            //prey settings
            var preyCount = 5;
            var PREY_SPEED = 5;
            var PREY_MATE_ENERGY_THRESHOLD = 0.4;
            var PREY_EAT_THRESHOLD = 0.8;
            var PREY_MATING_DURATION = 100;
            var PREY_MATE_SPAN = 1000;
            var PREY_AGE_MAX = 10;
            var PREY_MATE_AGE_MIN = 5;
            var PREY_MATE_DISTANCE = 40; //distance to detect and chase a prey of opposite gender
            var PREY_DISTACE_TO_PREDATOR = 50;
            var PREY_DISTANCE_TO_DETECT_FOOD = 30;
            var PREY_ENERGY_MAX = 1000;
            var PREY_NORMAL_HEARTBEAT = 60;

            //predator settings
            var predatorCount = 3;
            var PREDATOR_MATING_DURATION = 200;
            var PREDATOR_MATE_SPAN = 100;
            var PREDATOR_MATE_ENERGY_THRESHOLD = 0.6;
            var PREDATOR_SPEED = 3;
            var PREDATOR_EAT_THRESHOLD = 0.95;
            var PREDATOR_AGE_MAX = 20;
            var PREDATOR_MATE_AGE_MIN = 5;
            var PREDATOR_ENERGY_MAX = 5000;
            var PREDATOR_DETECT_PREY_DISTANCE = 250;
            var PREDATOR_MATE_DISTANCE = 60;

            //food settings
            var FOOD_ENERGY_MAX = 200;
            var FOOD_INTERVAL = 10000;
            var foodCount = 5;

            //general settings
            var debug = true;
            var AGE_INTERVAL = 5000;


            var food = [];
            var foodIdSeq = 0;
            var preyIdSeq = 0;
            var predatorIdSeq = 0;
            var spriteLength = 50;
            var preys = [];
            var predators = [];

            var foodIntervalHandle;
            var ageIntervalHandle;
            var simTimeHandle;

            var simTime;

            var renderer, stage, graphen;
            var graphType = 0;


            //stats
            var statsW = 300, statsH = 100;
            var statsS = 1; //Scale. 1 for 100px, 2 for 200px, etc. Should match the variable statsH.
            var malePredatorStat = 0x0000CD;
            var femalePredatorStat = 0x87CEEB;
            var foodStat = 0xFFA500;
            var malePreyStat = 0x8B008B;
            var femalePreyStat = 0xDDA0DD;
            var xdata = [], ydata = [];
            var xindex = 0;

            function selectGraphType() {
                graphType = parseInt(document.getElementById("graphOpts").value);
            }

            function initStatsContainer() {
                var container = document.getElementById('statistics');
                while (container.firstChild)
                    container.removeChild(container.firstChild);
                renderer = PIXI.autoDetectRenderer(statsW, statsH, null);
                renderer.plugins.interaction.autoPreventDefault = false;
                renderer.view.style['touch-action'] = 'auto';
                stage = new PIXI.Stage(0xAABBCC, false);
                graphen = new PIXI.Graphics();
                document.getElementById("statistics").appendChild(renderer.view);
                stage.addChild(graphen);
                graphen.position.x = statsW;
                graphen.position.y = statsH;
                xindex = 0;
                xdata = [];
                ydata = [];
            }

            function collectStats() {
                var malePreyCount = 0, femalePreyCount = 0;
                var malePredatorCount = 0, femalePredatorCount = 0;
                var foodCount = 0;
                xindex++;
                for (var i = 0; i < preys.length; i++) {
                    if (preys[i].mood !== DEAD) {
                        if (preys[i].gender === MALE)
                            malePreyCount++;
                        else
                            femalePreyCount++;
                    }
                }

                for (var i = 0; i < predators.length; i++) {
                    if (predators[i].mood !== DEAD) {
                        if (predators[i].gender === MALE)
                            malePredatorCount++;
                        else
                            femalePredatorCount++;
                    }
                }

                for (var i = 0; i < food.length; i++) {
                    if (food[i].energy > 0)
                        foodCount++;
                }

                xdata.push(xindex);
                ydata.push({mPrey: malePreyCount, fPrey: femalePreyCount, mPred: malePredatorCount, fPred: femalePredatorCount, f: foodCount});
                if (xindex > statsW) {
                    xdata.shift();
                    ydata.shift();
                }
                graphen.clear();

                //  console.clear();
                //var y = Math.random() * 20;
                //  ydata.push(-y);

                var total = 0;

                if (graphType === 1) {
                    var total;
                    for (var i = 0; i < xdata.length - 1; i++) {
                        total = ydata[i].f + ydata[i].mPred + ydata[i].fPred + ydata[i].mPrey + ydata[i].fPrey;

                        graphen.lineStyle(2, foodStat, 0.5);
                        graphen.moveTo(xdata[i], statsS * -((ydata[i].f * 100) / total));
                        graphen.lineTo(xdata[i + 1], statsS * -((ydata[i + 1].f * 100) / total));

                        graphen.lineStyle(2, malePredatorStat, 0.5);
                        graphen.moveTo(xdata[i], statsS * -(((ydata[i].mPred + ydata[i].fPred) * 100) / total));
                        graphen.lineTo(xdata[i + 1], statsS * -(((ydata[i + 1].mPred + ydata[i + 1].fPred) * 100) / total));

                        graphen.lineStyle(2, malePreyStat, 0.5);
                        graphen.moveTo(xdata[i], statsS * -(((ydata[i].mPrey + ydata[i].fPrey) * 100) / total));
                        graphen.lineTo(xdata[i + 1], statsS * -(((ydata[i + 1].mPrey + ydata[i + 1].fPrey) * 100) / total));
                    }
                }
                /* works only when real values are needed. When scale is not desired.
                 if (graphType === 1) {
                 var c = 10;
                 var total;
                 for (var i = 0; i < xdata.length - 1; i++) {
                 total = ydata[i].f + ydata[i].mPred + ydata[i].fPred + ydata[i].mPrey + ydata[i].fPrey;
                 graphen.lineStyle(2, foodStat, 1);
                 graphen.moveTo(xdata[i], c * -ydata[i].f);
                 graphen.lineTo(xdata[i + 1], c * -ydata[i + 1].f);
                 
                 graphen.lineStyle(2, malePredatorStat, 1);
                 graphen.moveTo(xdata[i], c * -ydata[i].mPred);
                 graphen.lineTo(xdata[i + 1], c * -ydata[i + 1].mPred);
                 
                 graphen.lineStyle(2, femalePredatorStat, 1);
                 graphen.moveTo(xdata[i], c * -ydata[i].fPred);
                 graphen.lineTo(xdata[i + 1], c * -ydata[i + 1].fPred);
                 
                 graphen.lineStyle(2, malePreyStat, 1);
                 graphen.moveTo(xdata[i], c * -ydata[i].mPrey);
                 graphen.lineTo(xdata[i + 1], c * -ydata[i + 1].mPrey);
                 
                 graphen.lineStyle(2, femalePreyStat, 1);
                 graphen.moveTo(xdata[i], c * -ydata[i].fPrey);
                 graphen.lineTo(xdata[i + 1], c * -ydata[i + 1].fPrey);
                 }
                 }*/

                var curr;
                if (graphType === 0)
                    for (var i = 0; i < xdata.length - 1; i++) {
                        curr = 0;
                        graphen.lineStyle(2, foodStat, 1);
                        //           graphen.moveTo(xdata[i],ydata[i]); 
                        //graphen.lineTo(xdata[i+1],ydata[i+1]);
                        total = ydata[i].f + ydata[i].mPred + ydata[i].fPred + ydata[i].mPrey + ydata[i].fPrey;
                        curr -= statsS * ((ydata[i].f * 100) / total);//ydata[i + 1].f * 10;
                        graphen.moveTo(xdata[i], 0);

                        graphen.lineTo(xdata[i], curr);
                        //  graphen.lineTo(xdata[i+1], ydata[i + 1].f * c);

                        graphen.lineStyle(2, femalePredatorStat, 1);
                        //   graphen.moveTo(xdata[i], curr);
                        curr -= statsS * ((ydata[i].fPred * 100) / total);//ydata[i + 1].fPred * 10;
                        graphen.lineTo(xdata[i + 1], curr);

                        graphen.lineStyle(2, malePredatorStat, 1);
                        //  graphen.moveTo(xdata[i], curr);
                        curr -= statsS * ((ydata[i].mPred * 100) / total); //ydata[i + 1].mPred * 10;
                        graphen.lineTo(xdata[i + 1], curr);

                        graphen.lineStyle(2, femalePreyStat, 1);
                        //   graphen.moveTo(xdata[i], curr);
                        curr -= statsS * ((ydata[i].fPrey * 100) / total); //ydata[i + 1].fPrey * 10;
                        graphen.lineTo(xdata[i + 1], curr);

                        graphen.lineStyle(2, malePreyStat, 1);
                        //    graphen.moveTo(xdata[i], curr);
                        curr -= statsS * ((ydata[i].mPrey * 100) / total); //ydata[i + 1].mPrey * 10;
                        graphen.lineTo(xdata[i + 1], curr);
                    }
                graphen.position.x -= 1;

                renderer.render(stage);
            }

            function increaseAgeInterval() {
                for (var i = 0; i < preys.length; i++) {
                    if (preys[i].mood === DEAD)
                        continue;
                    if (preys[i].age >= PREY_AGE_MAX) {
                        preys[i].energy = 0;
                        preys[i].mood = DEAD;
                        preys[i].texture = deadTexture;
                    }
                    preys[i].age++;
                }
                for (var i = 0; i < predators.length; i++) {
                    if (predators[i].mood === DEAD)
                        continue;
                    if (predators[i].age >= PREDATOR_AGE_MAX) {
                        predators[i].energy = 0;
                        predators[i].mood = DEAD;
                        predators[i].texture = predatorDeadTexture;
                    }
                    predators[i].age++;
                }
            }

            function createFoodInterval() {
                addFoodToWorld();
            }

            function increaseSimInterval() {
                simTime++;
                var seconds = 0, minutes = 0;
                if (simTime > 59) {
                    minutes = Math.floor(simTime / 60);
                    seconds = simTime % 60;
                    document.getElementById("simTime").innerHTML = minutes + ":" + seconds;
                } else {
                    document.getElementById("simTime").innerHTML = "00:" + ("0" + simTime).slice(-2);
                }
                if (simTime >= 300)
                    stop();
            }

            function loadSettings() {
                //prey settings
                preyCount = parseInt(document.getElementById('preyAmount').value);
                PREY_SPEED = parseInt(document.getElementById('preySpeed').value);
                PREY_DISTACE_TO_PREDATOR = parseInt(document.getElementById('distancePredator').value);
                PREY_DISTANCE_TO_DETECT_FOOD = parseInt(document.getElementById('distanceFood').value);
                PREY_EAT_THRESHOLD = parseFloat(document.getElementById('eatThreshold').value);
                PREY_MATE_DISTANCE = parseInt(document.getElementById('preyMateDistance').value);
                PREY_MATE_ENERGY_THRESHOLD = parseFloat(document.getElementById('preyMateThreshold').value);
                PREY_ENERGY_MAX = parseInt(document.getElementById('maxPreyEnergy').value);
                PREY_MATING_DURATION = parseInt(document.getElementById('preyMatingDuration').value);
                PREY_MATE_SPAN = parseInt(document.getElementById('preyMateSpan').value);
                PREY_AGE_MAX = parseInt(document.getElementById('preyMaxAge').value);
                PREY_MATE_AGE_MIN = parseInt(document.getElementById('preyMinMateAge').value);

                //predator settings
                predatorCount = parseInt(document.getElementById('predatorCount').value);
                PREDATOR_SPEED = parseInt(document.getElementById('predatorSpeed').value);
                PREDATOR_MATE_DISTANCE = parseInt(document.getElementById('predatorMateDistance').value);
                PREDATOR_DETECT_PREY_DISTANCE = parseInt(document.getElementById('distanceDetectPrey').value);
                PREDATOR_ENERGY_MAX = parseInt(document.getElementById('maxPredatorEnergy').value);
                PREDATOR_EAT_THRESHOLD = parseFloat(document.getElementById('predatorEatThreshold').value);
                PREDATOR_MATE_ENERGY_THRESHOLD = parseFloat(document.getElementById('predatorMateThreshold').value);
                PREDATOR_MATING_DURATION = parseInt(document.getElementById('predatorMatingDuration').value);
                PREDATOR_MATE_SPAN = parseInt(document.getElementById('predatorMateSpan').value);
                PREDATOR_AGE_MAX = parseInt(document.getElementById('predatorMaxAge').value);
                PREDATOR_MATE_AGE_MIN = parseInt(document.getElementById('predatorMinMateAge').value);

                //food settings
                FOOD_ENERGY_MAX = parseInt(document.getElementById('maxFoodEnergy').value);
                FOOD_INTERVAL = parseInt(document.getElementById('foodInterval').value);
                foodCount = parseInt(document.getElementById('foodAmount').value);

                //general settings
                debug = document.getElementById('inDebug').checked ? true : false;
                AGE_INTERVAL = parseInt(document.getElementById('ageInterval').value);

                food = [];
                preys = [];
                predators = [];
            }

            function getNextFoodId() {
                return "food" + foodIdSeq++;
            }

            function getNextPreyId() {
                return "prey" + preyIdSeq++;
            }

            function getNextPredatorId() {
                return "pred" + predatorIdSeq++;
            }

            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            function deltaMove(xdir, ydir, x, y, speed) {
                if (xdir === LEFT)
                    x -= speed;
                else if (xdir === RIGHT)
                    x += speed;
                if (ydir === UP)
                    y -= speed;
                else if (ydir === DOWN)
                    y += speed;

                if (x <= spriteLength)
                    xdir = RIGHT;
                else if (x >= windowWidth - spriteLength)
                    xdir = LEFT;

                if (y <= spriteLength)
                    ydir = DOWN;
                else if (y >= windowHeight - spriteLength)
                    ydir = UP;
                return {x: x, y: y, xdir: xdir, ydir: ydir};
            }

            function recycleWorld() {
                var container = document.getElementById('container');
                while (container.firstChild)
                    container.removeChild(container.firstChild);
            }


            function createPrey(x, y) {
                var prey = new PIXI.Sprite(happyTexture);
                prey.id = getNextPreyId();
                prey.anchor.set(0.5);
                prey.x = x ? x : getRandomInt(spriteLength, (window.innerWidth / 2) - spriteLength);
                prey.y = y ? y : getRandomInt(spriteLength, app.renderer.height - spriteLength);
                prey.xdir = XDIR[getRandomInt(0, 1)];
                prey.ydir = YDIR[getRandomInt(0, 1)];
                prey.mood = HAPPY;
                prey.interactiveChildren = false;
                prey.heartBeat = PREY_NORMAL_HEARTBEAT;
                prey.energy = PREY_ENERGY_MAX;
                prey.gender = GENDER[getRandomInt(0, 1)];
                prey.matingDuration = 0;
                prey.mateSpan = 0;
                prey.food = PREY_ENERGY_MAX; //when it dies, it provides this amount of food
                prey.mates = [];
                prey.plates = [];
                prey.age = getRandomInt(1, PREY_AGE_MAX);

                var baseHealthBar = new PIXI.Sprite(transparentBarTexture);
                baseHealthBar.x = -25;
                baseHealthBar.y = -40;

                var healthBar = new PIXI.Sprite(healthBarTexture); //new PIXI.Graphics();
                //  healthBar.beginFill(0x00BB00);
                // healthBar.lineStyle(1, 0x000000);
                // healthBar.drawRect(-25, -40, spriteLength, 5);
                healthBar.x = -25;
                healthBar.y = -40;
                healthBar.tint = 0x00FF00;
                prey.energyBar = healthBar;

                var genderFlag = new PIXI.Sprite(prey.gender === MALE ? maleTexture : femaleTexture);
                genderFlag.x = -45;
                genderFlag.y = -45;
                prey.genderFlag = genderFlag;

                var baseMateBar = new PIXI.Sprite(transparentBarTexture);
                baseMateBar.x = -25;
                baseMateBar.y = -50;

                var mateBar = new PIXI.Sprite(healthBarTexture);
                mateBar.x = -25;
                mateBar.y = -50;
                mateBar.tint = 0xAAAA00;
                prey.mateBar = mateBar;

                var baseAgeBar = new PIXI.Sprite(transparentBarTexture);
                baseAgeBar.x = -25;
                baseAgeBar.y = -60;

                var ageBar = new PIXI.Sprite(healthBarTexture);
                ageBar.x = -25;
                ageBar.y = -60;
                ageBar.tint = 0xBB00BB;
                prey.ageBar = ageBar;

                if (debug) {
                    var foodLOS = new PIXI.Graphics();
                    foodLOS.lineStyle(2, 0xFFFFFF);
                    foodLOS.drawCircle(0, 0, PREY_DISTANCE_TO_DETECT_FOOD);
                    prey.addChild(foodLOS);

                    var enemyLOS = new PIXI.Graphics();
                    enemyLOS.lineStyle(2, 0xFF0000);
                    enemyLOS.drawCircle(0, 0, PREY_DISTACE_TO_PREDATOR);
                    prey.addChild(enemyLOS);

                    var mateLOS = new PIXI.Graphics();
                    mateLOS.lineStyle(2, 0x800080);
                    mateLOS.drawCircle(0, 0, PREY_MATE_DISTANCE);
                    prey.addChild(mateLOS);

                }
                prey.addChild(baseAgeBar);
                prey.addChild(ageBar);
                prey.addChild(baseHealthBar);
                prey.addChild(baseMateBar);
                prey.addChild(mateBar);
                prey.addChild(healthBar);
                prey.addChild(genderFlag);
                return prey;
            }

            function addPreyToWorld(x, y) {
                var prey = createPrey(x, y);
                preys.push(prey);
                app.stage.addChild(prey);
            }

            function getActorInfo(p) {
                return {id: p.id
                    , x: p.x
                    , y: p.y
                    , xdir: p.xdir
                    , ydir: p.ydir
                    , age: p.age
                    , energy: p.energy
                    , mood: p.mood
                    , gender: p.gender
                    , matingDuration: p.matingDuration
                    , mateSpan: p.mateSpan
                    , mates: p.mates
                };
            }

            function createPredator(x, y) {
                var predator = new PIXI.Sprite(angryTexture);
                predator.id = getNextPredatorId();
                predator.anchor.set(0.5);
                predator.x = x ? x : getRandomInt(spriteLength, (window.innerWidth / 2) - spriteLength);
                predator.y = y ? y : getRandomInt(spriteLength, app.renderer.height - spriteLength);
                predator.xdir = XDIR[getRandomInt(0, 1)];
                predator.ydir = YDIR[getRandomInt(0, 1)];
                predator.energy = PREDATOR_ENERGY_MAX;
                predator.interactiveChildren = false;
                predator.mood = LURKING;
                predator.gender = GENDER[getRandomInt(0, 1)];
                predator.matingDuration = 0;
                predator.mateSpan = 0;
                predator.mates = [];
                predator.plates = [];
                predator.age = getRandomInt(1, PREDATOR_AGE_MAX);


                var baseHealthBar = new PIXI.Sprite(transparentBarTexture);
                baseHealthBar.x = -25;
                baseHealthBar.y = -40;

                var healthBar = new PIXI.Sprite(healthBarTexture);//new PIXI.Graphics();
                healthBar.x = -25;
                healthBar.y = -40;
                healthBar.tint = 0x00FF00;
                predator.energyBar = healthBar;

                var genderFlag = new PIXI.Sprite(predator.gender === MALE ? maleTexture : femaleTexture);
                genderFlag.x = -45;
                genderFlag.y = -45;
                predator.genderFlag = genderFlag;

                var baseMateBar = new PIXI.Sprite(transparentBarTexture);
                baseMateBar.x = -25;
                baseMateBar.y = -50;

                var mateBar = new PIXI.Sprite(healthBarTexture);
                mateBar.x = -25;
                mateBar.y = -50;
                mateBar.tint = 0xAAAA00;
                predator.mateBar = mateBar;

                var baseAgeBar = new PIXI.Sprite(transparentBarTexture);
                baseAgeBar.x = -25;
                baseAgeBar.y = -60;

                var ageBar = new PIXI.Sprite(healthBarTexture);
                ageBar.x = -25;
                ageBar.y = -60;
                ageBar.tint = 0xBB00BB;
                predator.ageBar = ageBar;

                if (debug) {
                    var foodLOS = new PIXI.Graphics();
                    foodLOS.lineStyle(2, 0xFFFFFF);
                    foodLOS.drawCircle(0, 0, PREDATOR_DETECT_PREY_DISTANCE);
                    predator.addChild(foodLOS);

                    /*   var enemyLOS = new PIXI.Graphics();
                     enemyLOS.lineStyle(2, 0xFF0000);
                     enemyLOS.drawCircle(0, 0, PREY_DISTACE_TO_PREDATOR);
                     predator.addChild(enemyLOS);*/

                    var mateLOS = new PIXI.Graphics();
                    mateLOS.lineStyle(2, 0x800080);
                    mateLOS.drawCircle(0, 0, PREDATOR_MATE_DISTANCE);
                    predator.addChild(mateLOS);

                }

                predator.addChild(baseAgeBar);
                predator.addChild(ageBar);
                predator.addChild(baseHealthBar);
                predator.addChild(baseMateBar);
                predator.addChild(mateBar);
                predator.addChild(healthBar);
                predator.addChild(genderFlag);
                return predator;
            }

            function addPredatorToWorld(x, y) {
                var predator = createPredator(x, y);
                predators.push(predator);
                app.stage.addChild(predator);
            }

            function createFood() {
                var food = new PIXI.Sprite(pizzaTexture);
                food.id = getNextFoodId();
                food.anchor.set(0.5);
                food.x = getRandomInt(spriteLength, app.renderer.width - spriteLength);
                food.y = getRandomInt(spriteLength, app.renderer.height - spriteLength);
                food.energy = FOOD_ENERGY_MAX;
                return food;
            }

            function addFoodToWorld() {
                var f = createFood();
                food.push(f);
                app.stage.addChild(f);
            }

            function fillWorld() {
                app = new PIXI.Application(windowWidth, windowHeight, {backgroundColor: 0x118C4E});
                app.renderer.plugins.interaction.autoPreventDefault = false;
                app.renderer.view.style['touch-action'] = 'auto';

                document.getElementById('container').appendChild(app.view);

                //Food
                for (var i = 0; i < foodCount; i++) {
                    addFoodToWorld();
                }

                //Preys
                for (var i = 0; i < preyCount; i++) {
                    addPreyToWorld();
                }

                //Predators
                for (var i = 0; i < predatorCount; i++) {
                    addPredatorToWorld();
                }
            }

            function isPredatorMateNear(x, y, gender, id) {
                var threshold = PREDATOR_MATE_DISTANCE;
                var mateDir = {xdir: null, ydir: null};
                for (var i = 0; i < predators.length; i++) {
                    if (predators[i].gender === gender)
                        continue;
                    if (predators[i].id === id)
                        continue;
                    if (predators[i].mood === MATING)
                        continue;
                    if (predators[i].mood === DEAD)
                        continue;
                    if (predators[i].age <= PREDATOR_MATE_AGE_MIN)
                        continue;
                    if (Math.abs(predators[i].x - x) < threshold && Math.abs(predators[i].y) - y < threshold) {
                        if (predators[i].x < x)
                            mateDir.xdir = LEFT;
                        else
                            mateDir.xdir = RIGHT;
                        if (predators[i].y < y)
                            mateDir.ydir = UP;
                        else
                            mateDir.ydir = DOWN;
                        return mateDir;
                    }

                }
            }

            function isPreyMateNear(x, y, gender, id) {
                var threshold = PREY_MATE_DISTANCE;
                var mateDir = {xdir: null, ydir: null};
                for (var i = 0; i < preys.length; i++) {
                    if (gender === preys[i].gender) //do not allow same gender sex
                        continue;
                    if (preys[i].id === id)
                        continue;
                    if (preys[i].mood === MATING)
                        continue;
                    if (preys[i].mood === DEAD)
                        continue;
                    if (preys[i].age <= PREY_MATE_AGE_MIN)
                        continue;
                    if (Math.abs(preys[i].x - x) < threshold && Math.abs(preys[i].y - y) < threshold) {
                        if (preys[i].x < x)
                            mateDir.xdir = LEFT;
                        else //if(preys[i].x > x)
                            mateDir.xdir = RIGHT;
                        if (preys[i].y < y)
                            mateDir.ydir = UP;
                        else
                            mateDir.ydir = DOWN;
                        return mateDir;
                    }
                }
                return false;
            }

            function hitTestRectangle(r1, r2) {
                var hit, combinedHalfWidths, combinedHalfHeights, vx, vy;
                hit = false;

                //Find the center points of each sprite
                r1.centerX = r1.x + r1.width / 2;
                r1.centerY = r1.y + r1.height / 2;
                r2.centerX = r2.x + r2.width / 2;
                r2.centerY = r2.y + r2.height / 2;

                //Find the half-widths and half-heights of each sprite
                r1.halfWidth = r1.width / 2;
                r1.halfHeight = r1.height / 2;
                r2.halfWidth = r2.width / 2;
                r2.halfHeight = r2.height / 2;

                //Calculate the distance vector between the sprites
                vx = r1.centerX - r2.centerX;
                vy = r1.centerY - r2.centerY;

                //Figure out the combined half-widths and half-heights
                combinedHalfWidths = r1.halfWidth + r2.halfWidth;
                combinedHalfHeights = r1.halfHeight + r2.halfHeight;

                //Check for a collision on the x axis
                if (Math.abs(vx) < combinedHalfWidths) {
                    //A collision might be occuring. Check for a collision on the y axis
                    if (Math.abs(vy) < combinedHalfHeights) {
                        //There's definitely a collision happening
                        hit = true;
                    } else {
                        //There's no collision on the y axis
                        hit = false;
                    }
                } else {
                    //There's no collision on the x axis
                    hit = false;
                }
                return hit;
            }

            function matePredatorFound(m) {
                for (var i = 0; i < predators.length; i++) {
                    if (m.id === predators[i].id)
                        continue;
                    if (m.gender === predators[i].gender)
                        continue;
                    if (predators[i].mood === MATING)
                        continue;
                    if (predators[i].age <= PREDATOR_MATE_AGE_MIN)
                        continue;
                    if (predators[i].mood === DEAD)
                        continue;
                    if (predators[i].energy >= PREDATOR_ENERGY_MAX * PREDATOR_MATE_ENERGY_THRESHOLD && hitTestRectangle(m, predators[i]))
                        return predators[i];
                }
            }

            function matePreyFound(m) {
                for (var i = 0; i < preys.length; i++) {
                    if (m.id === preys[i].id)
                        continue;
                    if (m.gender === preys[i].gender)
                        continue;
                    if (preys[i].mood === MATING)
                        continue;
                    if (preys[i].age <= PREY_MATE_AGE_MIN)
                        continue;
                    if (preys[i].mood === DEAD)
                        continue;
                    if (preys[i].energy > PREY_MATE_ENERGY_THRESHOLD * PREY_ENERGY_MAX && hitTestRectangle(m, preys[i])) //do not mate with dead preys
                        return preys[i];
                }
                return false;
            }

            //It will detect a dead prey and eat it.
            function deadPreyFound(p) {
                for (var i = 0; i < preys.length; i++) {
                    if (preys[i].mood !== DEAD)
                        continue;
                    if (preys[i].food > 0 && hitTestRectangle(p, preys[i]))
                        return preys[i];
                }
                return false;
            }

            function foodFound(p) {
                for (var i = 0; i < food.length; i++) {
                    if (food[i].energy <= 0)
                        continue;
                    if (hitTestRectangle(p, food[i]))
                        return food[i];
                }
                return false;
            }

            function isFoodNear(x, y) {
                var threshold = PREY_DISTANCE_TO_DETECT_FOOD;
                var foodDir = {xdir: null, ydir: null};
                for (var i = 0; i < food.length; i++) {
                    if (food[i].energy <= 0)
                        continue;
                    if (Math.abs(food[i].x - x) < threshold && Math.abs(food[i].y - y) < threshold) {
                        if (x >= food[i].x)
                            foodDir.xdir = LEFT;
                        else
                            foodDir.xdir = RIGHT;
                        if (food[i].y <= y)
                            foodDir.ydir = UP;
                        else
                            foodDir.ydir = DOWN;
                        return foodDir;
                    }
                }
                return null;
            }

            function isPreyNear(x, y) {
                var threshold = PREDATOR_DETECT_PREY_DISTANCE;
                var foodDir = {xdir: null, ydir: null};
                for (var i = 0; i < preys.length; i++) { //search for dead preys first
                    if (preys[i].mood === DEAD && preys[i].food > 0) {
                        if (Math.abs(preys[i].x - x) < threshold && Math.abs(preys[i].y - y) < threshold) {
                            if (x >= preys[i].x)
                                foodDir.xdir = LEFT;
                            else
                                foodDir.xdir = RIGHT;
                            if (preys[i].y <= y)
                                foodDir.ydir = UP;
                            else
                                foodDir.ydir = DOWN;
                            return foodDir;
                        }
                    }
                }
                for (var i = 0; i < preys.length; i++) {
                    if (preys[i].mood === DEAD)
                        continue;
                    if (Math.abs(preys[i].x - x) < threshold && Math.abs(preys[i].y - y) < threshold) {
                        if (x >= preys[i].x)
                            foodDir.xdir = LEFT;
                        else
                            foodDir.xdir = RIGHT;
                        if (preys[i].y <= y)
                            foodDir.ydir = UP;
                        else
                            foodDir.ydir = DOWN;
                        return foodDir;
                    }
                }
                return null;
            }

            function isPredatorNear(x, y) {
                var threshold = PREY_DISTACE_TO_PREDATOR;
                var runDir = {xdir: null, ydir: null};
                for (var i = 0; i < predators.length; i++) {
                    if (predators[i].mood === DEAD)
                        continue;
                    if (Math.abs(predators[i].x - x) < threshold && Math.abs(predators[i].y - y) < threshold) {
                        if (predators[i].x <= x)
                            runDir.xdir = RIGHT;
                        else
                            runDir.xdir = LEFT;
                        if (predators[i].y <= y)
                            runDir.ydir = DOWN;
                        else
                            runDir.ydir = UP;
                        //console.log("X:" + x + ",Y:" + y + " || Predator x:" + predators[i].x + ",Predator y:" + predators[i].y);
                        return runDir;
                    }
                }
                return null;
            }

            function updateLogic() {

                //update preys status
                for (var i = 0; i < preys.length; i++) {

                    //evaluate if prey is dead
                    if (preys[i].energy <= 0 || preys[i].mood === DEAD) {
                        if (preys[i].mood !== DEAD) {
                            preys[i].mood = DEAD;
                            preys[i].texture = deadTexture;
                            preys[i].removeChild(preys[i].energyBar);
                        }
                        continue;
                    }

                    preys[i].mateBar.scale.set(preys[i].mateSpan / PREY_MATE_SPAN, 1);
                    //update energy bar scale and color
                    preys[i].energyBar.scale.set(preys[i].energy / PREY_ENERGY_MAX, 1);
                    preys[i].ageBar.scale.set(preys[i].age / PREY_AGE_MAX, 1);
                    if (preys[i].energy <= PREY_ENERGY_MAX / 2 && preys[i].energy > PREY_ENERGY_MAX / 4) {
                        preys[i].energyBar.tint = 0xFFA500;
                    } else if (preys[i].energy <= PREY_ENERGY_MAX / 4)
                        preys[i].energyBar.tint = 0xFF0000;
                    else
                        preys[i].energyBar.tint = 0x00FF00;

                    //move only if it is happy, scared, or worried
                    if (preys[i].mood === HAPPY || preys[i].mood === SCARED || preys[i].mood === WORRIED) {
                        var newPos = deltaMove(preys[i].xdir, preys[i].ydir, preys[i].x, preys[i].y, PREY_SPEED);
                        preys[i].x = newPos.x;
                        preys[i].y = newPos.y;
                        preys[i].ydir = newPos.ydir;
                        preys[i].xdir = newPos.xdir;
                    }

                    //evaluate if predator is near. If true, change mood, heartbeat, and direction
                    var predatorNear = isPredatorNear(preys[i].x, preys[i].y);
                    if (predatorNear) {
                        preys[i].texture = scaredTexture;
                        preys[i].mood = SCARED;
                        preys[i].ydir = predatorNear.ydir;
                        preys[i].xdir = predatorNear.xdir;
                        preys[i].heartBeat = PREY_NORMAL_HEARTBEAT * 3;
                    }

                    //update the prey's heartbeat when it is running away from a predator. 
                    //if heartbeat is normal, then change the mood to happy. 
                    //if heartbeat less than twice as normal, then change mood to worried
                    //if heearteat continues to be more than twice than normal, then consume more energy
                    if (preys[i].mood === SCARED || preys[i].mood === WORRIED) {
                        if (preys[i].heartBeat <= PREY_NORMAL_HEARTBEAT) {
                            preys[i].texture = happyTexture;
                            preys[i].mood = HAPPY;
                        } else if (preys[i].heartBeat < PREY_NORMAL_HEARTBEAT * 2 && preys[i].mood === SCARED) {
                            preys[i].texture = worriedTexture;
                            preys[i].mood = WORRIED;
                            preys[i].heartBeat--;
                        } else {
                            preys[i].energy -= 2;//energy decreses x2 when scared
                            preys[i].heartBeat--;
                        }
                    }

                    if (preys[i].mood !== EATING)
                        preys[i].energy--;

                    if (preys[i].mood !== MATING && preys[i].mateSpan < PREY_MATE_SPAN)
                        preys[i].mateSpan++;

                    //if prey is running away from a predator it cannot perform the other activities
                    if (preys[i].mood === SCARED || preys[i].mood === WORRIED)
                        continue;

                    //increase energy if it is eating. Change to happy mood if it has full energy
                    if (preys[i].mood === EATING) {
                        if (preys[i].energy < PREY_ENERGY_MAX) {
                            if (preys[i].plates[0].energy > 0) {
                                preys[i].energy++;
                                preys[i].plates[0].energy--;
                            } else {
                                preys[i].plates[0].texture = emptyPlateTexture;
                                preys[i].plates.splice(0, 1);
                                preys[i].mood = HAPPY;
                                preys[i].texture = happyTexture;
                            }
                        } else {// if (preys[i].mood !== HAPPY) {
                            preys[i].plates.splice(0, 1);
                            preys[i].mood = HAPPY;
                            preys[i].texture = happyTexture;
                        }
                        continue;
                    }

                    //  if (preys[i].mood !== EATING) {                 
                    //increase mating duration if it is mating and reduce energy
                    if (preys[i].mood === MATING) {
                        preys[i].matingDuration++;
                        preys[i].energy--; //energy decreases again when mating
                        if (preys[i].matingDuration >= PREY_MATING_DURATION || preys[i].mates[0].mood === DEAD) {
                            preys[i].mateSpan = 0;
                            preys[i].mood = HAPPY;
                            preys[i].texture = happyTexture;
                            if (preys[i].gender === FEMALE)
                                addPreyToWorld(preys[i].x + spriteLength, preys[i].y + spriteLength);
                        }
                        continue;
                    }

                    //reproduce only if it has enough energy
                    if (preys[i].mood !== MATING && preys[i].energy >= PREY_ENERGY_MAX * PREY_MATE_ENERGY_THRESHOLD
                            && preys[i].mateSpan >= PREY_MATE_SPAN) {
                        //get closer to another prey of different sex
                        var mateDir = isPreyMateNear(preys[i].x, preys[i].y, preys[i].gender, preys[i].id);
                        if (mateDir) {
                            preys[i].ydir = mateDir.ydir;
                            preys[i].xdir = mateDir.xdir;
                            //reproduce if found partner
                            var mate = matePreyFound(preys[i]);
                            if (mate && mate.mateSpan >= PREY_MATE_SPAN) {
                                preys[i].mates.push(mate);
                                mate.mates.push(preys[i]);
                                preys[i].matingDuration = 0;
                                preys[i].mood = MATING;
                                preys[i].texture = matingTexture;
                                mate.matingDuration = 0;
                                mate.mood = MATING;
                                mate.texture = matingTexture;
                            }
                        }
                    }

                    //evaluate if it needs to eat
                    if (preys[i].mood !== EATING && preys[i].energy <= (PREY_ENERGY_MAX * PREY_EAT_THRESHOLD)) {
                        //get closer to the food
                        var foodDir = isFoodNear(preys[i].x, preys[i].y);
                        if (foodDir) {
                            //  preys[i].mood = EATING;
                            //  preys[i].texture = eatingTexture;
                            preys[i].ydir = foodDir.ydir;
                            preys[i].xdir = foodDir.xdir;
                            //eat if found food
                            var food = foodFound(preys[i]);
                            if (food) {
                                preys[i].mood = EATING;
                                preys[i].texture = eatingTexture;
                                preys[i].plates[0] = food;
                            }
                        }
                    }
                    //     }
                }
                //Update predators
                for (var i = 0; i < predators.length; i++) {
                    if (predators[i].energy <= 0 || predators[i].mood === DEAD) {
                        if (predators[i].mood !== DEAD) {
                            predators[i].mood = DEAD;
                            predators[i].texture = predatorDeadTexture;
                            //     predators[i].energyBar.scale.set(0, 1);
                            predators[i].removeChild(predators[i].energyBar);
                        }
                        continue;
                    }

                    predators[i].mateBar.scale.set(predators[i].mateSpan / PREDATOR_MATE_SPAN, 1);
                    predators[i].energyBar.scale.set(predators[i].energy / PREDATOR_ENERGY_MAX, 1);
                    predators[i].ageBar.scale.set(predators[i].age / PREDATOR_AGE_MAX, 1);
                    if (predators[i].energy <= PREDATOR_ENERGY_MAX / 2 && predators[i].energy > PREDATOR_ENERGY_MAX / 4) {
                        predators[i].energyBar.tint = 0xFFA500;
                    } else if (predators[i].energy <= PREDATOR_ENERGY_MAX / 4)
                        predators[i].energyBar.tint = 0xFF0000;
                    else
                        predators[i].energyBar.tint = 0x00FF00;

                    if (predators[i].mood !== EATING) {
                        predators[i].energy--;
                    }

                    if (predators[i].mood === LURKING) {
                        var newPos = deltaMove(predators[i].xdir, predators[i].ydir, predators[i].x, predators[i].y, PREDATOR_SPEED);
                        predators[i].x = newPos.x;
                        predators[i].y = newPos.y;
                        predators[i].ydir = newPos.ydir;
                        predators[i].xdir = newPos.xdir;
                    }

                    if (predators[i].mood !== EATING && predators[i].energy <= (PREDATOR_ENERGY_MAX * PREDATOR_EAT_THRESHOLD)
                            && predators[i].mood !== MATING) {
                        //get closer to the food
                        var foodDir = isPreyNear(predators[i].x, predators[i].y);
                        if (foodDir) {
                            predators[i].ydir = foodDir.ydir;
                            predators[i].xdir = foodDir.xdir;
                            //eat if found food
                            var deadPrey = deadPreyFound(predators[i]);
                            if (deadPrey) {
                                predators[i].mood = EATING;
                                predators[i].texture = eatingTexture;
                                predators[i].plates[0] = deadPrey;
                            }
                        }
                    }

                    if (predators[i].mood !== MATING && predators[i].mateSpan < PREDATOR_MATE_SPAN)
                        predators[i].mateSpan++;

                    if (predators[i].mood === EATING) {
                        if (predators[i].energy < PREDATOR_ENERGY_MAX) {
                            if (predators[i].plates[0].food > 0) {
                                predators[i].energy++;
                                predators[i].plates[0].food--;
                            } else {
                                predators[i].plates[0].texture = preySkullTexture;
                                predators[i].plates.splice(0, 1);
                                predators[i].mood = LURKING;
                                predators[i].texture = angryTexture;
                            }
                        } else {
                            predators[i].plates.splice(0, 1);
                            predators[i].mood = LURKING;
                            predators[i].texture = angryTexture;
                        }
                        continue;
                    }

                    if (predators[i].mood === MATING) {
                        predators[i].matingDuration++;
                        predators[i].energy--;
                        if (predators[i].matingDuration >= PREDATOR_MATING_DURATION || predators[i].mates[0].mood === DEAD) {
                            predators[i].mateSpan = 0;
                            predators[i].mood = LURKING;
                            predators[i].texture = angryTexture;
                            if (predators[i].gender === FEMALE)
                                addPredatorToWorld(predators[i].x + spriteLength, predators[i].y + spriteLength);
                        }
                        continue;
                    }

                    if (predators[i].mood !== MATING && predators[i].energy >= PREDATOR_ENERGY_MAX * PREDATOR_MATE_ENERGY_THRESHOLD && predators[i].mateSpan >= PREDATOR_MATE_SPAN) {
                        var mateDir = isPredatorMateNear(predators[i].x, predators[i].y, predators[i].gender, predators[i].id);
                        if (mateDir) {
                            predators[i].ydir = mateDir.ydir;
                            predators[i].xdir = mateDir.xdir;

                            var mate = matePredatorFound(predators[i]);

                            if (mate && mate.mateSpan >= PREDATOR_MATE_SPAN) {
                                predators[i].mates.push(mate);
                                mate.mates.push(predators[i]);
                                predators[i].matingDuration = 0;
                                predators[i].mood = MATING;
                                predators[i].texture = sleepingTexture;
                                mate.matingDuration = 0;
                                mate.mood = MATING;
                                mate.texture = sleepingTexture;
                            }
                        }
                    }
                }
                collectStats();
            }

            function update(delta) {
                updateLogic();
            }

            function stop() {
                document.getElementById("btnStart").style.display = "block";
                document.getElementById("btnStop").style.display = "none";
                app.ticker.remove(update);
                if (foodIntervalHandle)
                    window.clearInterval(foodIntervalHandle);
                if (ageIntervalHandle)
                    window.clearInterval(ageIntervalHandle);
                if (simTimeHandle)
                    window.clearInterval(simTimeHandle);
                running = false;
                // recycleWorld();
            }

            function start() {
                document.getElementById("btnStart").style.display = "none";
                document.getElementById("btnStop").style.display = "block";
                recycleWorld();
                if (running)
                    stop();
                foodIntervalHandle = window.setInterval(createFoodInterval, FOOD_INTERVAL);
                ageIntervalHandle = window.setInterval(increaseAgeInterval, AGE_INTERVAL);
                simTimeHandle = window.setInterval(increaseSimInterval, 1000);
                loadSettings();
                fillWorld();
                app.ticker.add(update);
                running = true;
                simTime = 0;
                document.getElementById("container").scrollIntoView();

                initStatsContainer();
            }

            function showConfig() {
                $('#initScreen').modal('show');
            }

            function initCarousel() {
                $('.carousel').carousel({
                    interval: 0
                    , wrap: false
                });
            }

            $(window).load(function () {
                showConfig();
                initCarousel();
            });

        </script>
    </body>
</html>