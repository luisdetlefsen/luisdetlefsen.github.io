<!DOCTYPE html>
<html>
    <head>
        <title>Prey and predator</title>
    </head>
    <body>

        <style>
            #container {
                width: 100%; /*can be in percentage also.*/
                height: auto;
                margin: 0 auto;
                padding: 10px;
                position: relative;
            }
        </style>
        <link href="Content/bootstrap.min.css" rel="stylesheet"/>
        <link href="Content/Site.css" rel="stylesheet"/>
        <script src="Scripts/jquery-2.1.4.min.js"></script>
        <script src="Scripts/pixi/pixi.min.js"></script>

        <div class="row">            
            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                <label for="preyAmount">Number of preys</label>
                <input class="form-control" id='preyAmount' type="number" value="5" step="1" min="0" />
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                <label for="preySpeed">Prey speed</label>
                <input class="form-control" id='preySpeed' type="number" value="5" />
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                <label for="predatorCount">Number of predators</label>
                <input class="form-control" id='predatorCount' type="number" value="3" />
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                <label for='predatorSpeed'>Predator speed</label>
                <input class="form-control"  id='predatorSpeed' type="number" value="2" />
            </div>            
        </div>
        <div class="row">

            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                <label for="foodAmount">Number of food</label>
                <input class="form-control" id='foodAmount' type="number" value="5" step="1" min="0" />
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                <label for="distancePredator">Distance for prey to detect predator</label>
                <input class="form-control" id='distancePredator' type="number" value="50" step="1" min="0" />
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                <label for="distanceFood">Distance for prey to detect food</label>
                <input class="form-control" id='distanceFood' type="number" value="30" step="1" min="0" />
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                <label for="eatThreshold">Eat when energy is below</label>
                <input class="form-control" id='eatThreshold' type="number" value="0.8" step="0.1" min="0" />
            </div>

        </div>

        <div class='row'>
            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                <label for="preyMateDistance">Distance to detect prey of another gender</label>
                <input class="form-control" id='preyMateDistance' type="number" value="40" step="1" min="0" />
            </div>

            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                <label for="preyMateThreshold">Prey will reproduce when energy is above</label>
                <input class="form-control" id='preyMateThreshold' type="number" value="0.4" step="0.1" min="0" />
            </div>

            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                <div class="form-check">
                    <label class="form-check-label">
                        <input class="form-check-input" type="checkbox" value="" id='inDebug'>
                        Display debug information
                    </label>
                </div>
            </div>

        </div>

        <div class='row'>
            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">
                <button type="submit" class="btn btn-primary" id="btnStart" onclick="start()">Start</button>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-12 col-xs-12">                    
                <button type="submit" class="btn btn-danger" id="btnStop" onclick='stop()'>Stop</button>                
            </div>
        </div>


        <div class="row">

            <div id="container" style="margin:10px;"></div>

        </div>



        <script>
            /* 
             * FIXME: a prey should not get out of the bounds of the world when it is running away
             prey should have energy
             prey should decrease its energy when it is not eating
             prey should increase its energy when it is eating
             prey should run towards food
             prey should eat only when energy is below a certain threshold
             TODO: prey should die if it gets in contact with a predator
             prey should seek another prey to mate
             prey should have a gender
             prey should mate with another prey of different sex
             prey mating act should have a duration
             prey should die if it runs out of energy
             TODO: predator should chase a prey when it is near
             TODO: prey should have a priority: mate or eat
             predator should have energy
             TODO: predator should seek another predator to mate
             TODO: predator should increase its energy when it eats a prey
             predator should decrease its energy when it is not eating
             predator should have a gender
             TODO: predator should mate with another predator of different sex
             predator should die if it runs out of energy
             TODO: food should have an amount that can be eaten
             TODO: food should spawn randomly every X time
             add urge to mate to prey 
             TODO; add urge to mate to predator
             */

            var windowWidth = window.innerWidth * 0.95;
            var windowHeight = window.innerHeight * 0.9;
            var app;
            var UP = 0, DOWN = 1, RIGHT = 2, LEFT = 3;
            var XDIR = [RIGHT, LEFT];
            var YDIR = [UP, DOWN];
            var DEAD = 0, EATING = 1, HAPPY = 2, SCARED = 3, SLEEPING = 4, WORRIED = 5, SMILE = 6, ANGRY = 7, MATING = 8, LURKING = 9, CHASING = 10;
            var moods = [DEAD, EATING, HAPPY, SCARED, SLEEPING, WORRIED, SMILE, ANGRY];
            var imagesBasePath = 'Content/img/smileys/';
            var pizzaTexture = PIXI.Texture.fromImage(imagesBasePath + 'pizzat.png');
            var deadTexture = PIXI.Texture.fromImage(imagesBasePath + 'deadt.png');
            var eatingTexture = PIXI.Texture.fromImage(imagesBasePath + 'eatingt.png');
            var happyTexture = PIXI.Texture.fromImage(imagesBasePath + 'happyt.png');
            var scaredTexture = PIXI.Texture.fromImage(imagesBasePath + 'scaredt.png');
            var sleepingTexture = PIXI.Texture.fromImage(imagesBasePath + 'sleeping.png');
            var worriedTexture = PIXI.Texture.fromImage(imagesBasePath + 'worriedt.png');
            var smileTexture = PIXI.Texture.fromImage(imagesBasePath + 'smile.png');
            var angryTexture = PIXI.Texture.fromImage(imagesBasePath + 'angryt.png');
            var matingTexture = PIXI.Texture.fromImage(imagesBasePath + 'sleeping.png');
            var femaleTexture = PIXI.Texture.fromImage(imagesBasePath + 'female.png');
            var maleTexture = PIXI.Texture.fromImage(imagesBasePath + 'male.png');
            var healthBarTexture = PIXI.Texture.fromImage(imagesBasePath + 'solidWhiteBar.png');
            var transparentBarTexture = PIXI.Texture.fromImage(imagesBasePath + 'transparentBar.png');
            var DISTANCE_PREY_MATE = 40; //distance to detect and chase a prey of opposite gender
            var PREY_MATE_PERIOD = 100;
            var MALE = 0, FEMALE = 1;
            var GENDER = [MALE, FEMALE];
            var NORMAL_HEARTBEAT = 60;
            var DISTACE_TO_PREDATOR = 50;
            var DISTANCE_TO_DETECT_FOOD = 30;
            var MAX_PREY_ENERGY = 1000;
            var PREDATOR_ENERGY = 4000;
            var running = false;
            var PREY_SPEED = 5, PREDATOR_SPEED = 3;
            var predatorCount = 3, preyCount = 5, foodCount = 5;
            var PREY_MATE_ENERGY_THRESHOLD = 0.4;
            var EAT_THRESHOLD = 0.8;
            var PREY_MATING_DURATION = 100;
            var PREY_MATE_SPAN = 1000;

            var food = [];
            var spriteLength = 50;
            var preyIdSeq = 0;
            var preys = [];
            var predators = [];

            var debug = true;

            function loadSettings() {
                preyCount = parseInt(document.getElementById('preyAmount').value);
                PREY_SPEED = parseInt(document.getElementById('preySpeed').value);
                predatorCount = parseInt(document.getElementById('predatorCount').value);
                PREDATOR_SPEED = parseInt(document.getElementById('predatorSpeed').value);
                foodCount = parseInt(document.getElementById('foodAmount').value);
                DISTACE_TO_PREDATOR = parseInt(document.getElementById('distancePredator').value);
                DISTANCE_TO_DETECT_FOOD = parseInt(document.getElementById('distanceFood').value);
                EAT_THRESHOLD = parseFloat(document.getElementById('eatThreshold').value);
                DISTANCE_PREY_MATE = parseInt(document.getElementById('preyMateDistance').value);
                debug = document.getElementById('inDebug').checked ? true : false;
                PREY_MATE_ENERGY_THRESHOLD = parseFloat(document.getElementById('preyMateThreshold').value);
                food = [];
                preys = [];
                predators = [];
            }

            function getNextPreyId() {
                return "prey" + preyIdSeq++;
            }

            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            function deltaMove(xdir, ydir, x, y, speed) {
                if (xdir === LEFT)
                    x -= speed;
                else if (xdir === RIGHT)
                    x += speed;
                if (ydir === UP)
                    y -= speed;
                else if (ydir === DOWN)
                    y += speed;

                if (x <= spriteLength)
                    xdir = RIGHT;
                else if (x >= windowWidth - spriteLength)
                    xdir = LEFT;

                if (y <= spriteLength)
                    ydir = DOWN;
                else if (y >= windowHeight - spriteLength)
                    ydir = UP;
                return {x: x, y: y, xdir: xdir, ydir: ydir};
            }

            function recycleWorld() {
                var container = document.getElementById('container');
                while (container.firstChild)
                    container.removeChild(container.firstChild);
            }


            function createPrey(x, y) {
                var prey = new PIXI.Sprite(happyTexture);
                prey.id = getNextPreyId();
                prey.anchor.set(0.5);
                prey.x = x ? x : getRandomInt(spriteLength, (window.innerWidth / 2) - spriteLength);
                prey.y = y ? y : getRandomInt(spriteLength, app.renderer.height - spriteLength);
                prey.xdir = XDIR[getRandomInt(0, 1)];
                prey.ydir = YDIR[getRandomInt(0, 1)];
                prey.mood = HAPPY;
                prey.heartBeat = NORMAL_HEARTBEAT;
                prey.energy = MAX_PREY_ENERGY;
                prey.gender = GENDER[getRandomInt(0, 1)];
                prey.matingDuration = 0;
                prey.mateSpan = 0;
                prey.food = MAX_PREY_ENERGY; //when it dies, it provides this amount of food
                prey.mates = [];

                var baseHealthBar = new PIXI.Sprite(transparentBarTexture);
                baseHealthBar.x = -25;
                baseHealthBar.y = -40;

                var healthBar = new PIXI.Sprite(healthBarTexture); //new PIXI.Graphics();
                //  healthBar.beginFill(0x00BB00);
                // healthBar.lineStyle(1, 0x000000);
                // healthBar.drawRect(-25, -40, spriteLength, 5);
                healthBar.x = -25;
                healthBar.y = -40;
                healthBar.tint = 0x00FF00;
                prey.energyBar = healthBar;

                var genderFlag = new PIXI.Sprite(prey.gender === MALE ? maleTexture : femaleTexture);
                genderFlag.x = -45;
                genderFlag.y = -45;
                prey.genderFlag = genderFlag;

                var baseMateBar = new PIXI.Sprite(transparentBarTexture);
                baseMateBar.x = -25;
                baseMateBar.y = -50;

                var mateBar = new PIXI.Sprite(healthBarTexture);
                mateBar.x = -25;
                mateBar.y = -50;
                mateBar.tint = 0xAAAA00;
                prey.mateBar = mateBar;

                if (debug) {
                    var foodLOS = new PIXI.Graphics();
                    foodLOS.lineStyle(2, 0xFFFFFF);
                    foodLOS.drawCircle(0, 0, DISTANCE_TO_DETECT_FOOD);
                    prey.addChild(foodLOS);

                    var enemyLOS = new PIXI.Graphics();
                    enemyLOS.lineStyle(2, 0xFF0000);
                    enemyLOS.drawCircle(0, 0, DISTACE_TO_PREDATOR);
                    prey.addChild(enemyLOS);

                    var mateLOS = new PIXI.Graphics();
                    mateLOS.lineStyle(2, 0x800080);
                    mateLOS.drawCircle(0, 0, DISTANCE_PREY_MATE);
                    prey.addChild(mateLOS);

                }
                prey.addChild(baseHealthBar);
                prey.addChild(baseMateBar);
                prey.addChild(mateBar);
                prey.addChild(healthBar);
                prey.addChild(genderFlag);
                return prey;
            }

            function addPreyToWorld(x, y) {
                var prey = createPrey(x, y);
                preys.push(prey);
                app.stage.addChild(prey);
            }
            function fillWorld() {
                app = new PIXI.Application(windowWidth, windowHeight, {backgroundColor: 0x1099bb});
                document.getElementById('container').appendChild(app.view);

                //Food
                for (var i = 0; i < foodCount; i++) {
                    food.push(new PIXI.Sprite(pizzaTexture));
                    food[i].anchor.set(0.5);
                    food[i].x = getRandomInt(spriteLength, app.renderer.width - spriteLength);
                    food[i].y = getRandomInt(spriteLength, app.renderer.height - spriteLength);
                    app.stage.addChild(food[i]);
                }

                //Preys
                for (var i = 0; i < preyCount; i++) {
                    addPreyToWorld();
                    //  preys.push(createPrey());
                    //  app.stage.addChild(preys[i]);
                    /* preys.push(new PIXI.Sprite(happyTexture));
                     preys[i].id = getNextPreyId();
                     preys[i].anchor.set(0.5);
                     preys[i].x = getRandomInt(spriteLength, (window.innerWidth / 2) - spriteLength);
                     preys[i].y = getRandomInt(spriteLength, app.renderer.height - spriteLength);
                     preys[i].xdir = XDIR[getRandomInt(0, 1)];
                     preys[i].ydir = YDIR[getRandomInt(0, 1)];
                     preys[i].mood = HAPPY;
                     preys[i].heartBeat = NORMAL_HEARTBEAT;
                     preys[i].energy = MAX_PREY_ENERGY;
                     preys[i].gender = GENDER[getRandomInt(0, 1)];
                     preys[i].matingDuration = 0;
                     preys[i].mateSpan = 0;
                     preys[i].food = MAX_PREY_ENERGY; //when it dies, it provides this amount of food
                     preys[i].mates = [];
                     
                     
                     var baseHealthBar = new PIXI.Sprite(transparentBarTexture);
                     baseHealthBar.x = -25;
                     baseHealthBar.y = -40;
                     
                     var healthBar = new PIXI.Sprite(healthBarTexture); //new PIXI.Graphics();
                     //  healthBar.beginFill(0x00BB00);
                     // healthBar.lineStyle(1, 0x000000);
                     // healthBar.drawRect(-25, -40, spriteLength, 5);
                     healthBar.x = -25;
                     healthBar.y = -40;
                     healthBar.tint = 0x00FF00;
                     preys[i].energyBar = healthBar;
                     
                     var genderFlag = new PIXI.Sprite(preys[i].gender === MALE ? maleTexture : femaleTexture);
                     genderFlag.x = -45;
                     genderFlag.y = -45;
                     preys[i].genderFlag = genderFlag;
                     
                     var baseMateBar = new PIXI.Sprite(transparentBarTexture);
                     baseMateBar.x = -25;
                     baseMateBar.y = -50;
                     
                     var mateBar = new PIXI.Sprite(healthBarTexture);
                     mateBar.x = -25;
                     mateBar.y = -50;
                     mateBar.tint = 0xAAAA00;
                     preys[i].mateBar = mateBar;
                     
                     if (debug) {
                     var foodLOS = new PIXI.Graphics();
                     foodLOS.lineStyle(2, 0xFFFFFF);
                     foodLOS.drawCircle(0, 0, DISTANCE_TO_DETECT_FOOD);
                     preys[i].addChild(foodLOS);
                     
                     var enemyLOS = new PIXI.Graphics();
                     enemyLOS.lineStyle(2, 0xFF0000);
                     enemyLOS.drawCircle(0, 0, DISTACE_TO_PREDATOR);
                     preys[i].addChild(enemyLOS);
                     
                     var mateLOS = new PIXI.Graphics();
                     mateLOS.lineStyle(2, 0x800080);
                     mateLOS.drawCircle(0, 0, DISTANCE_PREY_MATE);
                     preys[i].addChild(mateLOS);
                     
                     }
                     preys[i].addChild(baseHealthBar);
                     preys[i].addChild(baseMateBar);
                     preys[i].addChild(mateBar);
                     preys[i].addChild(healthBar);
                     preys[i].addChild(genderFlag);
                     app.stage.addChild(preys[i]);*/
                }



                //Predators
                for (var i = 0; i < predatorCount; i++) {
                    predators.push(new PIXI.Sprite(angryTexture));
                    predators[i].anchor.set(0.5);
                    predators[i].x = getRandomInt(spriteLength, (window.innerWidth / 2) - spriteLength);
                    predators[i].y = getRandomInt(spriteLength, app.renderer.height - spriteLength);
                    predators[i].xdir = XDIR[getRandomInt(0, 1)];
                    predators[i].ydir = YDIR[getRandomInt(0, 1)];
                    predators[i].energy = PREDATOR_ENERGY;
                    predators[i].mood = LURKING;
                    predators[i].gender = GENDER[getRandomInt(0, 1)];

                    var healthBar = new PIXI.Sprite(healthBarTexture);//new PIXI.Graphics();
                    healthBar.x = -25;
                    healthBar.y = -40;
                    healthBar.tint = 0x00FF00;
                    // healthBar.beginFill(0x00BB00);
                    // healthBar.lineStyle(1, 0x000000);
                    // healthBar.drawRect(-25, -40, spriteLength, 5);
                    predators[i].energyBar = healthBar;

                    var genderFlag = new PIXI.Sprite(predators[i].gender === MALE ? maleTexture : femaleTexture);
                    genderFlag.x = -45;
                    genderFlag.y = -45;
                    predators[i].genderFlag = genderFlag;

                    predators[i].addChild(healthBar);
                    predators[i].addChild(genderFlag);
                    app.stage.addChild(predators[i]);
                }
            }

            function isPreyMateNear(x, y, gender, id) {
                var threshold = DISTANCE_PREY_MATE;
                var mateDir = {xdir: null, ydir: null};
                for (var i = 0; i < preyCount; i++) {
                    if (gender === preys[i].gender) //do not allow same gender sex
                        continue;
                    if (preys[i].id === id)
                        continue;
                    if (preys[i].mood === MATING)
                        continue;
                    if (preys[i].energy <= 0)
                        continue;
                    if (Math.abs(preys[i].x - x) < threshold && Math.abs(preys[i].y - y) < threshold) {
                        if (preys[i].x < x)
                            mateDir.xdir = LEFT;
                        else //if(preys[i].x > x)
                            mateDir.xdir = RIGHT;
                        if (preys[i].y < y)
                            mateDir.ydir = UP;
                        else
                            mateDir.ydir = DOWN;
                        return mateDir;
                    }
                }
                return false;
            }

            function hitTestRectangle(r1, r2) {

                //Define the variables we'll need to calculate
                var hit, combinedHalfWidths, combinedHalfHeights, vx, vy;

                //hit will determine whether there's a collision
                hit = false;

                //Find the center points of each sprite
                r1.centerX = r1.x + r1.width / 2;
                r1.centerY = r1.y + r1.height / 2;
                r2.centerX = r2.x + r2.width / 2;
                r2.centerY = r2.y + r2.height / 2;

                //Find the half-widths and half-heights of each sprite
                r1.halfWidth = r1.width / 2;
                r1.halfHeight = r1.height / 2;
                r2.halfWidth = r2.width / 2;
                r2.halfHeight = r2.height / 2;

                //Calculate the distance vector between the sprites
                vx = r1.centerX - r2.centerX;
                vy = r1.centerY - r2.centerY;

                //Figure out the combined half-widths and half-heights
                combinedHalfWidths = r1.halfWidth + r2.halfWidth;
                combinedHalfHeights = r1.halfHeight + r2.halfHeight;

                //Check for a collision on the x axis
                if (Math.abs(vx) < combinedHalfWidths) {

                    //A collision might be occuring. Check for a collision on the y axis
                    if (Math.abs(vy) < combinedHalfHeights) {

                        //There's definitely a collision happening
                        hit = true;
                    } else {

                        //There's no collision on the y axis
                        hit = false;
                    }
                } else {

                    //There's no collision on the x axis
                    hit = false;
                }

                //`hit` will be either `true` or `false`
                return hit;
            }

            function matePreyFound(m) {
                for (var i = 0; i < preyCount; i++) {
                    if (m.id === preys[i].id)
                        continue;
                    if (m.gender === preys[i].gender)
                        continue;
                    if (preys[i].mood === MATING)
                        continue;
                    if (preys[i].energy > 0 && hitTestRectangle(m, preys[i])) //do not mate with dead preys
                        return preys[i];
                }
                return false;
            }

            function foodFound(p) {
                for (var i = 0; i < foodCount; i++) {
                    if (hitTestRectangle(p, food[i]))
                        return food[i];
                }
                return false;
            }
            function isFoodNear(x, y) {
                var threshold = DISTANCE_TO_DETECT_FOOD;
                var foodDir = {xdir: null, ydir: null};
                for (var i = 0; i < foodCount; i++) {
                    if (Math.abs(food[i].x - x) < threshold && Math.abs(food[i].y - y) < threshold) {
                        if (x >= food[i].x)
                            foodDir.xdir = LEFT;
                        else
                            foodDir.xdir = RIGHT;
                        if (food[i].y <= y)
                            foodDir.ydir = UP;
                        else
                            foodDir.ydir = DOWN;
                        return foodDir;
                    }
                }
                return null;
            }

            function isPredatorNear(x, y) {
                var threshold = DISTACE_TO_PREDATOR;
                var runDir = {xdir: null, ydir: null};
                for (var i = 0; i < predatorCount; i++) {
                    if (Math.abs(predators[i].x - x) < threshold && Math.abs(predators[i].y - y) < threshold) {
                        if (predators[i].x <= x)
                            runDir.xdir = RIGHT;
                        else
                            runDir.xdir = LEFT;
                        if (predators[i].y <= y)
                            runDir.ydir = DOWN;
                        else
                            runDir.ydir = UP;
                        //console.log("X:" + x + ",Y:" + y + " || Predator x:" + predators[i].x + ",Predator y:" + predators[i].y);
                        return runDir;
                    }
                }
                return null;
            }

            function updateLogic() {

                //update preys status
                for (var i = 0; i < preys.length; i++) {

                    //evaluate if prey is dead
                    if (preys[i].energy <= 0) {
                        if (preys[i].mood !== DEAD) {
                            preys[i].mood = DEAD;
                            preys[i].texture = deadTexture;
                            preys[i].removeChild(preys[i].energyBar);
                        }
                        continue;
                    }

                    preys[i].mateBar.scale.set(preys[i].mateSpan / PREY_MATE_SPAN, 1);
                    //update energy bar scale and color
                    preys[i].energyBar.scale.set(preys[i].energy / MAX_PREY_ENERGY, 1);
                    if (preys[i].energy <= MAX_PREY_ENERGY / 2 && preys[i].energy > MAX_PREY_ENERGY / 4) {
                        preys[i].energyBar.tint = 0xFFA500;
                    } else if (preys[i].energy <= MAX_PREY_ENERGY / 4)
                        preys[i].energyBar.tint = 0xFF0000;
                    else
                        preys[i].energyBar.tint = 0x00FF00;

                    //move only if it is happy, scared, or worried
                    if (preys[i].mood === HAPPY || preys[i].mood === SCARED || preys[i].mood === WORRIED) {
                        var newPos = deltaMove(preys[i].xdir, preys[i].ydir, preys[i].x, preys[i].y, PREY_SPEED);
                        preys[i].x = newPos.x;
                        preys[i].y = newPos.y;
                        preys[i].ydir = newPos.ydir;
                        preys[i].xdir = newPos.xdir;
                    }

                    //evaluate if predator is near. If true, change mood, heartbeat, and direction
                    var predatorNear = isPredatorNear(preys[i].x, preys[i].y);
                    if (predatorNear) {
                        preys[i].texture = scaredTexture;
                        preys[i].mood = SCARED;
                        preys[i].ydir = predatorNear.ydir;
                        preys[i].xdir = predatorNear.xdir;
                        preys[i].heartBeat = NORMAL_HEARTBEAT * 3;
                    }

                    //update the prey's heartbeat when it is running away from a predator. 
                    //if heartbeat is normal, then change the mood to happy. 
                    //if heartbeat less than twice as normal, then change mood to worried
                    //if heearteat continues to be more than twice than normal, then consume more energy
                    if (preys[i].mood === SCARED || preys[i].mood === WORRIED) {
                        if (preys[i].heartBeat <= NORMAL_HEARTBEAT) {
                            preys[i].texture = happyTexture;
                            preys[i].mood = HAPPY;
                        } else if (preys[i].heartBeat < NORMAL_HEARTBEAT * 2 && preys[i].mood === SCARED) {
                            preys[i].texture = worriedTexture;
                            preys[i].mood = WORRIED;
                            preys[i].heartBeat--;
                        } else {
                            preys[i].energy -= 2;//energy decreses x2 when scared
                            preys[i].heartBeat--;
                        }
                    }

                    if (preys[i].mood !== EATING)
                        preys[i].energy--;

                    if (preys[i].mood !== MATING && preys[i].mateSpan < PREY_MATE_SPAN)
                        preys[i].mateSpan++;

                    //if prey is running away from a predator it cannot perform the other activities
                    if (preys[i].mood === SCARED || preys[i].mood === WORRIED)
                        continue;

                    //increase energy if it is eating. Change to happy mood if it has full energy
                    if (preys[i].mood === EATING) {
                        if (preys[i].energy < MAX_PREY_ENERGY)
                            preys[i].energy++;
                        else if (preys[i].mood !== HAPPY) {
                            preys[i].mood = HAPPY;
                            preys[i].texture = happyTexture;
                        }
                        continue;
                    }

                    //  if (preys[i].mood !== EATING) {                 

                    //increase mating duration if it is mating and reduce energy
                    if (preys[i].mood === MATING) {
                        preys[i].matingDuration++;
                        preys[i].energy--; //energy decreases again when mating
                        if (preys[i].matingDuration >= PREY_MATING_DURATION || preys[i].mates[0].energy <= 0) {
                            preys[i].mateSpan = 0;
                            preys[i].mood = HAPPY;
                            preys[i].texture = happyTexture;                            
                            if(preys[i].gender === FEMALE)
                                addPreyToWorld(preys[i].x + spriteLength, preys[i].y + spriteLength);
                        }
                        continue;
                    }

                    //reproduce only if it has enough energy
                    if (preys[i].mood !== MATING && preys[i].energy >= MAX_PREY_ENERGY * PREY_MATE_ENERGY_THRESHOLD
                            && preys[i].mateSpan >= PREY_MATE_SPAN) {
                        //get closer to another prey of different sex
                        var mateDir = isPreyMateNear(preys[i].x, preys[i].y, preys[i].gender, preys[i].id);
                        if (mateDir) {
                            preys[i].ydir = mateDir.ydir;
                            preys[i].xdir = mateDir.xdir;
                            //reproduce if found partner
                            var mate = matePreyFound(preys[i]);
                            if (mate && mate.mateSpan >= PREY_MATE_SPAN) {
                                preys[i].mates.push(mate);
                                mate.mates.push(preys[i]);
                                preys[i].matingDuration = 0;
                                preys[i].mood = MATING;
                                preys[i].texture = matingTexture;
                                mate.mood = MATING;
                                mate.texture = matingTexture;
                            }
                        }
                    }


                    //evaluate if it needs to eat
                    if (preys[i].mood !== EATING && preys[i].energy <= (MAX_PREY_ENERGY * EAT_THRESHOLD)) {

                        //get closer to the food
                        var foodDir = isFoodNear(preys[i].x, preys[i].y);
                        if (foodDir) {
                            //  preys[i].mood = EATING;
                            //  preys[i].texture = eatingTexture;
                            preys[i].ydir = foodDir.ydir;
                            preys[i].xdir = foodDir.xdir;
                            //eat if found food
                            if (foodFound(preys[i])) {
                                preys[i].mood = EATING;
                                preys[i].texture = eatingTexture;
                            }
                        }
                    }



                    //     }
                }

                //Update predators
                for (var i = 0; i < predatorCount; i++) {
                    predators[i].energyBar.scale.set(predators[i].energy / PREDATOR_ENERGY, 1);
                    if (predators[i].energy <= PREDATOR_ENERGY / 2 && predators[i].energy > PREDATOR_ENERGY / 4) {
                        predators[i].energyBar.tint = 0xFFA500;
                    } else if (predators[i].energy <= PREDATOR_ENERGY / 4)
                        predators[i].energyBar.tint = 0xFF0000;
                    else
                        predators[i].energyBar.tint = 0x00FF00;

                    if (predators[i].energy <= 0) {
                        if (predators[i].mood !== DEAD) {
                            predators[i].mood = DEAD;
                            predators[i].texture = deadTexture;
                            predators[i].energyBar.scale.set(0, 1);
                        }
                        continue;
                    }

                    if (predators[i].mood !== EATING) {
                        predators[i].energy--;
                    }

                    var newPos = deltaMove(predators[i].xdir, predators[i].ydir, predators[i].x, predators[i].y, PREDATOR_SPEED);
                    predators[i].x = newPos.x;
                    predators[i].y = newPos.y;
                    predators[i].ydir = newPos.ydir;
                    predators[i].xdir = newPos.xdir;
                }
            }


            function update(delta) {
                updateLogic();
            }

            function stop() {
                app.ticker.remove(update);
                running = false;
                // recycleWorld();
            }

            function start() {
                document.getElementById("container").scrollIntoView();
                recycleWorld();
                if (running)
                    stop();

                loadSettings();
                fillWorld();
                app.ticker.add(update);
                running = true;
            }


        </script>
    </body>
</html>